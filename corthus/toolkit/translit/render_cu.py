#!/usr/bin/python
# -*- coding: utf-8 -*-

"""
Script that renders a church-slavonic text in a way that it can be displayed
nicely with the "Triodion" font (and maybe other c-s. fonts as well).
This implementation is based on the HIP standard (http://orthlib.ru/hip/).

Usage: ./render_cu.py <file>  (to use text file as input)
       ./render_cu.py -       (to use standard input)
"""

from __future__ import unicode_literals

import sys

pairs = [
#    (r"%<",     "<em>"),
#    (r"%>",     "</em>"),
#    (r"%[",     "<strong>"),
#    (r"%]",     "</strong>"),
#    (r"%<<",    "<span>"),
#    (r"%>>",    "</span>"),

    (r"-",      "-"), # –¥–µ—Ñ–∏—Å
    #  <?>            # –≤–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –∑–Ω–∞–∫ –æ–±—ã—á–Ω–æ–≥–æ –≤–∏–¥–∞
    (r"'",      "1"), # –æ—Å—Ç—Ä–æ–µ ( /-–æ–±—Ä–∞–∑–Ω–æ–µ ) —É–¥–∞—Ä–µ–Ω–∏–µ (–∞–∫—É—Ç)
    (r"`",      "2"), # —Ç—è–∂–µ–ª–æ–µ ( \-–æ–±—Ä–∞–∑–Ω–æ–µ ) —É–¥–∞—Ä–µ–Ω–∏–µ (–≥—Ä–∞–≤–∏—Å)
    #  ''             # //-–æ–±—Ä–∞–∑–Ω—ã–π –Ω–∞–¥—Å—Ç—Ä–æ—á–Ω—ã–π –∑–Ω–∞–∫
    #  ``             # \\-–æ–±—Ä–∞–∑–Ω—ã–π –Ω–∞–¥—Å—Ç—Ä–æ—á–Ω—ã–π –∑–Ω–∞–∫
    (r"^",      "6"), # –æ–±–ª–µ—á–µ–Ω–Ω–æ–µ —É–¥–∞—Ä–µ–Ω–∏–µ (—Ü–∏—Ä–∫—É–º—Ñ–ª–µ–∫—Å)
    #  "              # –¥–≤–∞ –Ω–∞–¥—Å—Ç—Ä–æ—á–Ω—ã—Ö —à—Ç—Ä–∏—Ö–∞, –Ω–∞–∫–ª–æ–Ω –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ–≤–∞–∂–µ–Ω –∏–ª–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
    (r"<((>",   "¬´"), # <<-–æ–±—Ä–∞–∑–Ω–∞—è –∏–ª–∏ ((-–æ–±—Ä–∞–∑–Ω–∞—è (–≤ –≥—Ä–µ—á–µ—Å–∫–æ–º —Ä–µ–∂–∏–º–µ) –∫–∞–≤—ã—á–∫–∞
    (r"<))>",   "¬ª"), # >>-–æ–±—Ä–∞–∑–Ω–∞—è –∏–ª–∏ ))-–æ–±—Ä–∞–∑–Ω–∞—è (–≤ –≥—Ä–µ—á–µ—Å–∫–æ–º —Ä–µ–∂–∏–º–µ) –∫–∞–≤—ã—á–∫–∞
    #  \.             # —Ç–æ—á–∫–∞ –Ω–∞–¥ –±—É–∫–≤–æ–π
    #  \:             # –¥–≤–µ —Ç–æ—á–∫–∏ –Ω–∞–¥ –±—É–∫–≤–æ–π ( –Å = –ï\: )
    ( '"',      "¬∞"), # U-–æ–±—Ä–∞–∑–Ω—ã–π –Ω–∞–¥—Å—Ç—Ä–æ—á–Ω—ã–π –∑–Ω–∞–∫, –æ–±—ã—á–Ω–æ —Å–∏–º–≤–æ–ª –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ ( –ô = –ò\@ )
    (r"<.>",    "¬∑"), # —Ç–æ—á–∫–∞ –Ω–∞ —Å—Ä–µ–¥–Ω–µ–π –ª–∏–Ω–∏–∏ —Å—Ç—Ä–æ–∫–∏
    #  \-             # –∑–Ω–∞–∫ "–ø–æ–∫—Ä—ã—Ç–∏–µ"
    #  |.             # —Ç–æ—á–∫–∞ –ø–æ–¥ –±—É–∫–≤–æ–π
    #  |-             # —á–µ—Ä—Ç–∞ –ø–æ–¥ –±—É–∫–≤–æ–π
    #  |–æ             # –∫—Ä—É–∂–æ–∫ –ø–æ–¥ –±—É–∫–≤–æ–π

    (r"@",      "Íôæ"),

    (r"–∞",      "–∞"), # + –ê–ó
    (r"–ê",      "–ê"),
    (r"–∞=",     "“ë"), # +
    (r"–ê=",     "“ê"),
    (r"–∞='",    "—ì"), # +
    (r"–ê='",    "–É"),
    (r"–∞^",     "‚Ä†"),
    (r"–∞~",     "‚Ññ"),
    (r"–±",      "–±"), # + –ë–£–ö–ò
    (r"–ë",      "–ë"),
    (r"–≤",      "–≤"), # + –í–ï–î–ò
    (r"–í",      "–í"),
    (r"–≥",      "–≥"), # + –ì–õ–ê–ì–û–õ–¨
    (r"–ì",      "–ì"),
    (r"–≥~",     "G"),
    (r"–¥",      "–¥"), # + –î–û–ë–†–û
    (r"–î",      "–î"),
    (r"–µ",      "–µ"), # + –ï–°–¢–¨
    (r"–ï",      "–ï"),
    (r"–µ'",     "E"),
    (r"_–µ",     "—î"), # –ï–°–¢–¨ ("—à–∏—Ä–æ–∫–æ–µ" –∏–ª–∏ "–¥–ª–∏–Ω–Ω–æ–µ" –Ω–∞—á–µ—Ä—Ç–∞–Ω–∏–µ)
    (r"<–µ>",    "—î"), # –ï–°–¢–¨ ("—à–∏—Ä–æ–∫–æ–µ" –∏–ª–∏ "–¥–ª–∏–Ω–Ω–æ–µ" –Ω–∞—á–µ—Ä—Ç–∞–Ω–∏–µ)
    (r"_–ï",     "–ï"),
    (r"<–ï>",    "–ï"),
    (r"j—å",     "—ç"), # + –Ø–¢–¨
    (r"J–¨",     "–≠"),
    (r"j—å'",    "—ë"),
    (r"j—å`",    "–Å"),
    (r"j—å^",    "B"),
    (r"–∂",      "–∂"), # + –ñ–ò–í–ï–¢–ï
    (r"–ñ",      "–ñ"),
    (r"–∂~",     "9"),
    (r"s",      "—ï"), # + –ó–ï–õ–û
    (r"S",      "–Ö"),
    (r"–∑",      "–∑"), # + –ó–ï–ú–õ–Ø
    (r"–ó",      "–ó"),
    (r"–∏",      "–∏"), # + –ò–ñ–ï ("–ò" 8-–†–ò–ß–ù–û–ï)
    (r"–ò",      "–ò"),
    (r"–∏~",     "}"),
    (r"i",      "—ñ"), # + "–ò" 10-–†–ò–ß–ù–û–ï (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å 2 —Ç–æ—á–∫–∞–º–∏, —Å–º. –ø. I.13)
    (r"I",      "–Ü"),
    (r"i'",     "j"),
    (r"i`",     "J"),
    (r"i^",     "‚Ä°"),
    (r"i=",     "—ó"), # +
    (r"I=",     "–á"),
    (r"i='",    "—ò"), # +
    (r"I='",    "–à"),
    (r"_i",     "i"), # + (i –±–µ–∑ —Ç–æ—á–µ–∫)
    (r"_I",     "I"),
    (r"<i>",    "i"), # + (i –±–µ–∑ —Ç–æ—á–µ–∫)
    (r"<I>",    "I"),
    (r"v",      "v"), # + –ò–ñ–ò–¶–ê (–±–µ–∑ –Ω–∞–¥—Å—Ç—Ä–æ—á–Ω–∏–∫–æ–≤)
    (r"V",      "V"),
    (r"v'",     "–Ç"),
    ( "v\"",    "m"), # +
    ( "V\"",    "M"),
    (r"v^",     "‚Ä∫"),
    (r"v\–≥",    "—í"),
    (r"V\–ì",    "—í"),
    (r"–π",      "–π"), # + –ò–ñ–ï –ö–†–ê–¢–ö–û–ï
    (r"–ô",      "–ô"),
    (r"_i",     "i"), # + (i –±–µ–∑ —Ç–æ—á–µ–∫)
    (r"_I",     "I"),
    (r"–∫",      "–∫"), # + –ö–ê–ö–û
    (r"–ö",      "–ö"),
    (r"_–∫—Å",    "x"), # + –ö–°–ò
    (r"_–ö–°",    "X"),
    (r"_–ö—Å",    "X"),
    (r"_–∫—Å~",   "‚Ä¶"),
    (r"<–∫—Å>",   "x"), # + –ö–°–ò
    (r"<–ö–°>",   "X"),
    (r"<–ö—Å>",   "X"),
    (r"<–∫—Å>~",  "‚Ä¶"),
    (r"–ª",      "–ª"), # + –õ–Æ–î–ò
    (r"–õ",      "–õ"),
    (r"–ª~",     "l"),
    (r"–ª\–¥",    "L"),
    (r"–º",      "–º"), # + –ú–´–°–õ–ï–¢–ï
    (r"–ú",      "–ú"),
    (r"–Ω",      "–Ω"), # + –ù–ê–®
    (r"–ù",      "–ù"),
    (r"–æ",      "–æ"), # + –û–ù
    (r"–û",      "–û"),
    (r"–æ'",     "0"),
    (r"_–æ",     "o"), # + –û–ù (—à–∏—Ä–æ–∫–æ–µ –Ω–∞—á–µ—Ä—Ç–∞–Ω–∏–µ)
    (r"_–û",     "O"),
    (r"_–æ=",    "n"), # +
    (r"_–û=",    "N"),
    (r"_–æ='",   "—ü"), # +
    (r"_–û='",   "–è"),
    (r"<–æ>",    "o"), # + –û–ù (—à–∏—Ä–æ–∫–æ–µ –Ω–∞—á–µ—Ä—Ç–∞–Ω–∏–µ)
    (r"<–û>",    "O"),
    (r"<–æ>=",   "n"), # +
    (r"<–û>=",   "N"),
    (r"<–æ>='",  "—ü"), # +
    (r"<–û>='",  "–è"),
    (r"w",      "w"), # + –û–ú–ï–ì–ê
    (r"W",      "W"),
    (r"w'",     "H"),
    (r"w=",     "—ö"), # +
    (r"W=",     "–ä"),
    (r"_w",     "q"), # + –û–ú–ï–ì–ê –®–ò–†–û–ö–ê–Ø (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å –≤–µ–ª–∏–∫–∏–º –∞–ø–æ—Å—Ç—Ä–æ—Ñ–æ–º, —Å–º. –ø. I.13)
    (r"_W",     "Q"),
    (r"<w>",    "q"), # + –û–ú–ï–ì–ê –®–ò–†–û–ö–ê–Ø (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å –≤–µ–ª–∏–∫–∏–º –∞–ø–æ—Å—Ç—Ä–æ—Ñ–æ–º, —Å–º. –ø. I.13)
    (r"<W>",    "Q"),
    (r"w\—Ç",    "t"), # –û–¢
    (r"w\—Ç~",   "t\\"),
    (r"W\—Ç",    "T"),
    (r"W\–¢",    "T"),
    (r"–ø",      "–ø"), # + –ü–û–ö–û–ô
    (r"–ü",      "–ü"),
    (r"_–ø—Å",    "p"), # + –ü–°–ò
    (r"_–ü–°",    "P"),
    (r"_–ü—Å",    "P"),
    (r"_–ø—Å~",   "p\\"),
    (r"<–ø—Å>",   "p"), # + –ü–°–ò
    (r"<–ü–°>",   "P"),
    (r"<–ü—Å>",   "P"),
    (r"<–ø—Å>~",  "p\\"),
    (r"—Ä",      "—Ä"), # + –†–¶–´
    (r"–†",      "–†"),
    (r"—Ä~",     "R"),
    (r"—Ä\–¥",    "¬Æ"),
    (r"—Ä\—Å",    "r"),
    (r"—Å",      "—Å"), # + –°–õ–û–í–û
    (r"–°",      "–°"),
    (r"—Å~",     "¬©"),
    (r"—Ç",      "—Ç"), # + –¢–í–ï–†–î–û
    (r"–¢",      "–¢"),
    (r"—É",      "—É"), # + –£–ö (–≥–∞–º–º–∞–æ–±—Ä–∞–∑–Ω–æ–µ)
    (r"–£",      "–£"),
    (r"—É'",     "y"),
    (r"—É^",     "{"),
    (r"—É`",     "Y"),
    (r"_—É",     "¬µ"), # –ò–ö (—á–∏—Å–ª–æ–≤–æ–π –∑–Ω–∞–∫ 400 –∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–∏–≥—Ä–∞—Ñ–∞ –æ<—É> )
    (r"<—É>",    "¬µ"), # –ò–ö (—á–∏—Å–ª–æ–≤–æ–π –∑–Ω–∞–∫ 400 –∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–∏–≥—Ä–∞—Ñ–∞ –æ<—É> )
    (r"–æ_—É",    "s"), # –£–ö (–Ω–∞—á–µ—Ä—Ç–∞–Ω–∏–µ –æ—É), –æ–Ω –∂–µ –û–ù–ò–ö
    (r"–æ_—É=",   "—û"),
    (r"–æ_—É='",  "—ú"),
    (r"–û_–£",    "S"),
    (r"–û_–£=",   "–é"),
    (r"–û_–£='",  "–å"),
    (r"–æ<—É>",   "s"), # –£–ö (–Ω–∞—á–µ—Ä—Ç–∞–Ω–∏–µ –æ—É), –æ–Ω –∂–µ –û–ù–ò–ö
    (r"–æ<—É>=",  "—û"),
    (r"–æ<—É>='", "—ú"),
    (r"–û<–£>",   "S"),
    (r"–û<–£>=",  "–é"),
    (r"–û<–£>='", "–å"),
    (r"—Ñ",      "—Ñ"), # + –§–ï–†–¢
    (r"–§",      "–§"),
    (r"—Ñ~",     "—Ñ&"),
    (r"f",      "f"), # + –§–ò–¢–ê
    (r"F",      "F"),
    (r"—Ö",      "—Ö"), # + –•–ï–†
    (r"–•",      "–•"),
    (r"—Ö~",     "¬¶"),
    (r"—Ü",      "—Ü"), # + –¶–´
    (r"–¶",      "–¶"),
    (r"—á",      "—á"), # + –ß–ï–†–í–¨
    (r"–ß",      "–ß"),
    (r"—á~",     "¬ß"),
    (r"—à",      "—à"), # + –®–ê
    (r"–®",      "–®"),
    (r"—â",      "—â"), # + –©–ê
    (r"–©",      "–©"),
    (r"—ä",      "—ä"), # + –ï–†
    (r"–™",      "–™"),
    (r"—ã",      "—ã"), # + –ï–†–´ (–≤ –æ–±—ã—á–Ω–æ–º –≤–∏–¥–µ –¨I)
    (r"–´",      "–´"),
    (r"—ã'",     "h"),
    (r"—å",      "—å"), # + –ï–†–¨
    (r"–¨",      "–¨"),
    (r"—é",      "—é"), # + –Æ
    (r"–Æ",      "–Æ"),
    (r"j–∞",     "—è"), # –Ø (–≤ –≤–∏–¥–µ "–ª–∏–≥–∞—Ç—É—Ä—ã" I–ê )
    (r"ja^",    "‚Ä∞"),
    (r"ja=",    "k"),
    (r"ja='",   "—õ"),
    (r"ja=`",   "¬±"),
    (r"J–∞",     "–Ø"),
    (r"J–∞^",    "–â"),
    (r"Ja=",    "K"),
    (r"Ja='",   "–ã"),
    (r"J–ê",     "–Ø"),
    (r"J–ê^",    "–â"),
    (r"J–ê=",    "K"),
    (r"J–ê='",   "–ã"),
    (r"—è",      "z"), # + –Æ–° –ú–ê–õ–´–ô
    (r"–Ø",      "Z"),
    (r"—è'",     "s"),
    (r"—è`",     "S"),
    (r"—è=",     "—ô"), # +
    (r"–Ø=",     "–â"),
    (r"—è=`",    "|"),

    (r"=",      "3"), # —Ç–æ–Ω–∫–æ–µ –ø—Ä–∏–¥—ã—Ö–∞–Ω–∏–µ
    (r"='",     "4"), # —Ç–æ–Ω–∫. –ø—Ä–∏–¥. + –æ—Å—Ç—Ä–æ–µ —É–¥–∞—Ä–µ–Ω–∏–µ
    #  =^             # —Ç–æ–Ω–∫. –ø—Ä–∏–¥. + –æ–±–ª–µ—á–µ–Ω–Ω–æ–µ —É–¥–∞—Ä–µ–Ω–∏–µ (–∑–Ω–∞–∫ "–≤–µ–ª–∏–∫–∏–π –∞–ø–æ—Å—Ç—Ä–æ—Ñ")
    (r"=`",     "5"), # —Ç–æ–Ω–∫. –ø—Ä–∏–¥. + —Ç—è–∂–µ–ª–æ–µ —É–¥–∞—Ä–µ–Ω–∏–µ
    #  "              # –¥–≤–∞ —à—Ç—Ä–∏—Ö–∞ \\ –Ω–∞–¥ –±—É–∫–≤–æ–π (–æ—Å–æ–±. –Ω–∞–¥ –∏–∂–∏—Ü–µ–π), –Ω–µ –æ–±–æ–∑–Ω–∞—á–∞—é—â–∏–µ –≤—ã–Ω–æ—Å–Ω–æ–≥–æ –ò –∏–ª–∏ –ô
    (r"~",      "7"), # –ø—Ä–æ—Å—Ç–æ–µ —Ç–∏—Ç–ª–æ
    (r"#",      "¬§"), # —á–∏—Å–ª–æ–≤–æ–π –∑–Ω–∞–∫ –¥–ª—è —Ç—ã—Å—è—á
    (r"*",      "*"), # –∑–≤–µ–∑–¥–æ—á–∫–∞ (—Å–≤–µ—Ç–ª–∞—è, –≤ –≤–∏–¥–µ –≤–µ—Ä—Ö–Ω–µ–≥–æ –∏–Ω–¥–µ–∫—Å–∞)

    # –±—É–∫–≤–µ–Ω–Ω—ã–µ —Ç–∏—Ç–ª–∞. –í –±–æ–ª–µ–µ –¥—Ä–µ–≤–Ω–∏—Ö —Ç–µ–∫—Å—Ç–∞—Ö –∏—Ö –±—ã–ª–æ –±–æ–ª—å—à–µ;
    # –∏–∑ –¥–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —É–ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å–Ω—ã —Ç–æ–ª—å–∫–æ
    # –≤ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ: \—Ç —Ç–æ–ª—å–∫–æ –≤ —Å–æ—Å—Ç–∞–≤–µ –±—É–∫–≤—ã w\—Ç
    # \–≤, \—Ö, \—á -- —Ç–æ–ª—å–∫–æ –≤ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è—Ö —Å–ª–æ–≤ "–≥–ª–∞–≤–∞", "—Å—Ç–∏—Ö" –∏ "–∑–∞—á–∞–ª–æ"
    (r"\–≥",     "g"),
    (r"\–¥",     "d"),
    (r"\–æ",     "b"),
    (r"\—Ä",     ">"),
    (r"\—Å",     "c"),
    (r"\—Ö",     "<"),
    (r"\—á",     "?"),
    (r"\—ä",     "8"), # –ø–∞–µ—Ä–æ–∫

    (r":",      ":"),
    (r";",      ";"),
    (r",",      ","),
    (r".",      "."),
    (r"(",      "("),
    (r")",      ")"),
    (r"{",      "["),
    (r"}",      "]"),
    (r"[",      "["),
    (r"]",      "]"),
    (r"!",      "!"),
    (r"/",      "/"),

    (r"0",      "ùüò"),
    (r"1",      "ùüô"),
    (r"2",      "ùüö"),
    (r"3",      "ùüõ"),
    (r"4",      "ùüú"),
    (r"5",      "ùüù"),
    (r"6",      "ùüû"),
    (r"7",      "ùüü"),
    (r"8",      "ùü†"),
    (r"9",      "ùü°"),

    (r"¬∂",      "¬∂"),
]

pairs = dict(pairs)
max_pattern_len = max(len(k) for k in pairs)

def render_cu(string):
    result = ""
    last_char_was_upper = False

    while string:
        stopped = False
        for j in range(max_pattern_len, 0, -1): # trying longer matches first
            if string[:j] in pairs:
                replacement = pairs[string[:j]]
                # a hack to fit accents over uppercase letters
                if last_char_was_upper:
                    if   replacement == "1": replacement = "~"
                    elif replacement == "2": replacement = "@"
                    elif replacement == "3": replacement = "#"
                    elif replacement == "4": replacement = "$"
                    elif replacement == "5": replacement = "%"
                    elif replacement == "6": replacement = "^"
                    elif replacement == "7": replacement = "&"
                    elif replacement == "8": replacement = "_"
                result += replacement
                last_char_was_upper = string[:j].isupper()
                string = string[j:]
                stopped = True
                break
        if not stopped:
            if string[:1] in [" ", "\n", "\r", "\t"]:
                result += string[:1]
            else:
                result += "‚ç∞"
            last_char_was_upper = string[:1].isupper()
            string = string[1:]

    return result

if __name__ == '__main__':
    try:
        [filename] = sys.argv[1:]
        if filename == '-':
            inputFile = sys.stdin
        else:
            inputFile = open(filename)
    except ValueError:
        print __doc__
        print "Patterns replaced (in random order):"
        for (a, b) in pairs.items():
            print ("%20s ‚Üí %s" % (a, b)).encode('utf-8')
        sys.exit()
    for line in inputFile:
        line = line.decode('utf-8')
        line = render_cu(line)
        print line[:-1].encode('utf-8') # omitting '\n'
    inputFile.close()
